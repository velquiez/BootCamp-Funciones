#######################################################

1. Revise las reglas del firewall. Quite las reglas demasiado permisivas.

-> VPC nerwork
-> Revisar Subnets = deben haber 2 subredes (acne... , acme-mg...)

-> Firewall - openaccess

-> click sobre "Name" para ver region = ueast-4-c(por ejemplo) o escribir en la consola = echo $ZONE

-> Debajo del botón donde se da inicio al laboratorio está la siguiente información (cambiante) para reemplazar en la siguientes líneas:

    1. allow-ssh-iap-ingress-ql-228
    2. allow-ssh-internal-ingress-ql-268
    3. allow-http-ingress-ql-925


export IAP_NETWORK_TAG=allow-ssh-iap-ingress-ql-228

export INTERNAL_NETWORK_TAG=allow-ssh-internal-ingress-ql-268

export HTTP_NETWORK_TAG=allow-http-ingress-ql-925

export ZONE=us-east4-c

Luego se escribe el siguiente comando: 

gcloud compute firewall-rules delete open-access

##############################################


2. Navegue a Compute Engine en Cloud Console e identifique el host de bastión. La instancia no debe estar en ejecución. Inicie la instancia.


 -> Vamos a COMPUTE ENGINE
 -> Se observa de "bastion" está desactivada y "juice-shop" está activa.

-> Ingresamos a "bastion"
-> Buscamos "Start" y damos click (buscar en los 3 puntos)


#################################################

3. El host de bastión es la única máquina autorizada para recibir tráfico SSH externo. Cree una regla de firewall que permita el tráfico SSH (tcp/22) desde el servicio IAP. La regla de firewall se debe habilitar para la instancia de host de bastión mediante una etiqueta de red de allow-ssh-iap-ingress-ql-228.



gcloud compute firewall-rules create ssh-ingress --allow=tcp:22 --source-ranges 35.235.240.0/20 --target-tags $IAP_NETWORK_TAG --network acme-vpc
 
gcloud compute instances add-tags bastion --tags=$IAP_NETWORK_TAG --zone=$ZONE
 
###################################################

4. El servidor juice-shop entrega tráfico HTTP. Cree una regla de firewall que permita el tráfico en HTTP (tcp/80) a cualquier dirección. La regla de firewall se debe habilitar para la instancia de juice-shop mediante una etiqueta de red de allow-http-ingress-ql-925.

gcloud compute firewall-rules create http-ingress --allow=tcp:80 --source-ranges 0.0.0.0/0 --target-tags $HTTP_NETWORK_TAG --network acme-vpc
 
gcloud compute instances add-tags juice-shop --tags=$HTTP_NETWORK_TAG --zone=$ZONE
 
########################################

5. Debe conectarse a juice-shop desde el host de bastión mediante SSH. Cree una regla de firewall que permita el tráfico mediante SSH (tcp/22) desde la dirección de red acme-mgmt-subnet. La regla de firewall se debe habilitar para la instancia de juice-shop mediante una etiqueta de red de allow-ssh-internal-ingress-ql-268

gcloud compute firewall-rules create internal-ssh-ingress --allow=tcp:22 --source-ranges 192.168.10.0/24 --target-tags $INTERNAL_NETWORK_TAG --network acme-vpc
 
gcloud compute instances add-tags juice-shop --tags=$INTERNAL_NETWORK_TAG --zone=$ZONE

#################################################

6. En la página de instancias de Compute Engine, haga clic en el botón SSH para conectarse al host de bastión. Una vez conectado, permita el acceso SSH a juice-shop.

Task 6 : SSH to bastion host via IAP and juice-shop via bastion
In Compute Engine -> VM Instances page, click the SSH button for the bastion host. Then SSH to juice-shop by

->Estando en COMPUTE ENGINE - bastion
-> Voy a bastion 
-> SSH = Despliego la pestaña y abro = "Open in broser window".
 
Escribo el siguiente reglon:
 
gcloud compute ssh juice-shop --internal-ip

-> Doy "yes" ...creo una frase...."yes"...listo.

Creditos a: https://www.youtube.com/@quick_lab